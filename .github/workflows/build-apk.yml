name: Build Android APK

on:
  push:
    branches:
      - main
    paths:
      - 'android/**'
      - '.github/workflows/build-apk.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        working-directory: ./android
        run: flutter pub get

      - name: Build APK
        working-directory: ./android
        run: flutter build apk --release

      - name: Get version from pubspec
        id: version
        working-directory: ./android
        run: |
          VERSION=$(grep '^version: ' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: galmuri-diary-v${{ steps.version.outputs.version }}
          path: android/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Create Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}-${{ github.run_number }}
          name: Galmuri Diary v${{ steps.version.outputs.version }} (Build ${{ github.run_number }})
          body: |
            ## ğŸ“± ê°ˆë¬´ë¦¬ ë‹¤ì´ì–´ë¦¬ Android APK
            
            ### ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜ ë°©ë²•
            1. ì•„ë˜ **app-release.apk** íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”
            2. ì•ˆë“œë¡œì´ë“œ í°ìœ¼ë¡œ íŒŒì¼ì„ ì „ì†¡í•˜ì„¸ìš”
            3. íŒŒì¼ì„ íƒ­í•˜ì—¬ ì„¤ì¹˜í•˜ì„¸ìš”
            4. "ì•Œ ìˆ˜ ì—†ëŠ” ì†ŒìŠ¤" ì„¤ì¹˜ í—ˆìš©ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            
            ### ì£¼ìš” ê¸°ëŠ¥
            - ğŸ“¸ ê°¤ëŸ¬ë¦¬/ì¹´ë©”ë¼ì—ì„œ ì´ë¯¸ì§€ ì„ íƒ
            - ğŸ–¼ï¸ í™”ë©´ ìº¡ì²˜ ê¸°ëŠ¥ (ì•ˆë“œë¡œì´ë“œ ì „ìš©)
            - ğŸ“ ì œëª© ë° ë©”ëª¨ ì¶”ê°€
            - ğŸ” ê²€ìƒ‰ ê¸°ëŠ¥
            - â˜ï¸ Render ë°±ì—”ë“œ ì—°ë™
            
            ### ë²„ì „ ì •ë³´
            - Version: ${{ steps.version.outputs.version }}
            - Build: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
          files: |
            android/build/app/outputs/flutter-apk/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
